<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::title}, ~{::content})}">
<head>
    <title>Reports - Healthcare Dashboard</title>
</head>
<body>
    <div th:fragment="content">
        <!-- Page Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Medical Reports</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateReportModal">
                <i class="fas fa-plus me-2"></i>Generate New Report
            </button>
        </div>

        <!-- Report Types Cards -->
        <div class="row mb-4">
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-3x text-primary mb-3"></i>
                        <h5>Patient Summary</h5>
                        <p class="text-muted">Comprehensive patient statistics and demographics</p>
                        <button class="btn btn-outline-primary" onclick="generateQuickReport('PATIENT_SUMMARY')">
                            Generate
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-stethoscope fa-3x text-success mb-3"></i>
                        <h5>Treatment Analysis</h5>
                        <p class="text-muted">Treatment outcomes and cost analysis</p>
                        <button class="btn btn-outline-success" onclick="generateQuickReport('TREATMENT_ANALYSIS')">
                            Generate
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-dollar-sign fa-3x text-warning mb-3"></i>
                        <h5>Financial Report</h5>
                        <p class="text-muted">Revenue and expense analysis</p>
                        <button class="btn btn-outline-warning" onclick="generateQuickReport('FINANCIAL_REPORT')">
                            Generate
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Generated Reports</h5>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" id="filterReportType" style="width: auto;">
                        <option value="">All Types</option>
                        <option value="PATIENT_SUMMARY">Patient Summary</option>
                        <option value="TREATMENT_ANALYSIS">Treatment Analysis</option>
                        <option value="MEDICAL_RECORDS_REPORT">Medical Records</option>
                        <option value="APPOINTMENT_REPORT">Appointments</option>
                        <option value="FINANCIAL_REPORT">Financial</option>
                        <option value="CUSTOM_REPORT">Custom</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshReports()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="reportsTable">
                        <thead class="table-light">
                            <tr>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Generated By</th>
                                <th>Generated At</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Reports data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Loading indicator -->
                <div id="loadingIndicator" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading reports...</p>
                </div>
                
                <!-- No data message -->
                <div id="noDataMessage" class="text-center py-4" style="display: none;">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No reports found</p>
                </div>
            </div>
        </div>

        <!-- Generate Report Modal -->
        <div class="modal fade" id="generateReportModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Generate New Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="generateReportForm">
                            <div class="mb-3">
                                <label class="form-label">Report Title *</label>
                                <input type="text" class="form-control" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Report Type *</label>
                                <select class="form-select" name="type" required>
                                    <option value="">Select Report Type</option>
                                    <option value="PATIENT_SUMMARY">Patient Summary</option>
                                    <option value="TREATMENT_ANALYSIS">Treatment Analysis</option>
                                    <option value="MEDICAL_RECORDS_REPORT">Medical Records Report</option>
                                    <option value="APPOINTMENT_REPORT">Appointment Report</option>
                                    <option value="FINANCIAL_REPORT">Financial Report</option>
                                    <option value="CUSTOM_REPORT">Custom Report</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" name="description" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" name="startDate">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" class="form-control" name="endDate">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Additional Parameters</label>
                                <textarea class="form-control" name="parameters" rows="2" 
                                    placeholder="Enter JSON parameters (optional)"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="generateReport()">
                            <i class="fas fa-cog me-1"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Details Modal -->
        <div class="modal fade" id="reportDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="reportDetailsTitle">Report Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="reportDetailsContent">
                            <!-- Report details will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="downloadReport()">
                            <i class="fas fa-download me-1"></i>Download
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let reports = [];
            let currentReportId = null;

            // Load reports on page load
            document.addEventListener('DOMContentLoaded', function() {
                loadReports();
            });

            async function loadReports() {
                try {
                    // Mock data for reports
                    reports = [
                        {
                            id: '1',
                            title: 'Monthly Patient Summary - January 2024',
                            type: 'PATIENT_SUMMARY',
                            generatedBy: 'Dr. Smith',
                            generatedAt: '2024-01-31T10:30:00',
                            status: 'COMPLETED'
                        },
                        {
                            id: '2',
                            title: 'Treatment Outcomes Analysis Q1 2024',
                            type: 'TREATMENT_ANALYSIS',
                            generatedBy: 'Dr. Johnson',
                            generatedAt: '2024-01-28T14:15:00',
                            status: 'COMPLETED'
                        },
                        {
                            id: '3',
                            title: 'Financial Report - January 2024',
                            type: 'FINANCIAL_REPORT',
                            generatedBy: 'Admin',
                            generatedAt: '2024-01-25T09:00:00',
                            status: 'GENERATING'
                        }
                    ];
                    
                    displayReports(reports);
                    document.getElementById('loadingIndicator').style.display = 'none';
                } catch (error) {
                    console.error('Error loading reports:', error);
                    document.getElementById('loadingIndicator').style.display = 'none';
                    document.getElementById('noDataMessage').style.display = 'block';
                }
            }

            function displayReports(reportsToShow) {
                const tbody = document.getElementById('reportsTableBody');
                
                if (reportsToShow.length === 0) {
                    document.getElementById('noDataMessage').style.display = 'block';
                    tbody.innerHTML = '';
                    return;
                }
                
                document.getElementById('noDataMessage').style.display = 'none';
                
                tbody.innerHTML = reportsToShow.map(report => `
                    <tr>
                        <td>
                            <strong>${report.title}</strong>
                            ${report.description ? `<br><small class="text-muted">${report.description}</small>` : ''}
                        </td>
                        <td>
                            <span class="badge bg-info">${formatReportType(report.type)}</span>
                        </td>
                        <td>${report.generatedBy}</td>
                        <td>${formatDateTime(report.generatedAt)}</td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(report.status)}">
                                ${report.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="viewReport('${report.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success me-1" onclick="downloadReport('${report.id}')">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteReport('${report.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            function formatReportType(type) {
                return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            }

            function formatDateTime(dateTime) {
                return new Date(dateTime).toLocaleString();
            }

            function getStatusBadgeClass(status) {
                switch(status) {
                    case 'COMPLETED': return 'bg-success';
                    case 'GENERATING': return 'bg-warning';
                    case 'FAILED': return 'bg-danger';
                    default: return 'bg-secondary';
                }
            }

            function generateQuickReport(type) {
                const title = `${formatReportType(type)} - ${new Date().toLocaleDateString()}`;
                
                // Set form values and show modal
                document.querySelector('[name="title"]').value = title;
                document.querySelector('[name="type"]').value = type;
                
                const modal = new bootstrap.Modal(document.getElementById('generateReportModal'));
                modal.show();
            }

            async function generateReport() {
                const form = document.getElementById('generateReportForm');
                const formData = new FormData(form);
                
                const reportData = {
                    title: formData.get('title'),
                    type: formData.get('type'),
                    description: formData.get('description'),
                    startDate: formData.get('startDate'),
                    endDate: formData.get('endDate'),
                    generatedBy: 'Current User', // This would come from authentication
                    parameters: formData.get('parameters') ? JSON.parse(formData.get('parameters')) : {}
                };

                try {
                    // This would call the actual API
                    console.log('Generating report:', reportData);
                    
                    // Mock success
                    alert('Report generation started successfully!');
                    
                    // Close modal and refresh
                    bootstrap.Modal.getInstance(document.getElementById('generateReportModal')).hide();
                    form.reset();
                    
                    // Refresh reports list
                    setTimeout(() => {
                        loadReports();
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error generating report:', error);
                    alert('Error generating report. Please try again.');
                }
            }

            function viewReport(id) {
                currentReportId = id;
                const report = reports.find(r => r.id === id);
                
                if (report) {
                    document.getElementById('reportDetailsTitle').textContent = report.title;
                    
                    // Mock report content
                    const content = `
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Report Information</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>Type:</strong></td><td>${formatReportType(report.type)}</td></tr>
                                    <tr><td><strong>Generated By:</strong></td><td>${report.generatedBy}</td></tr>
                                    <tr><td><strong>Generated At:</strong></td><td>${formatDateTime(report.generatedAt)}</td></tr>
                                    <tr><td><strong>Status:</strong></td><td><span class="badge ${getStatusBadgeClass(report.status)}">${report.status}</span></td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6>Report Summary</h6>
                                <p>This is a sample report content. In a real implementation, this would show the actual report data, charts, and analysis.</p>
                                <canvas id="reportChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('reportDetailsContent').innerHTML = content;
                    
                    const modal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
                    modal.show();
                }
            }

            function downloadReport(id) {
                alert(`Download report ${id} functionality would be implemented here`);
            }

            function deleteReport(id) {
                if (confirm('Are you sure you want to delete this report?')) {
                    reports = reports.filter(r => r.id !== id);
                    displayReports(reports);
                }
            }

            function refreshReports() {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';
                loadReports();
            }

            function filterReports() {
                const typeFilter = document.getElementById('filterReportType').value;
                
                const filtered = reports.filter(report => {
                    return !typeFilter || report.type === typeFilter;
                });
                
                displayReports(filtered);
            }

            // Add event listener for filtering
            document.getElementById('filterReportType').addEventListener('change', filterReports);
        </script>
    </div>
</body>
</html>
