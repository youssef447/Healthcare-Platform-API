<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Data Upload - Healthcare Platform</title>
    <th:block>
        <link rel="stylesheet" th:href="@{/css/dropzone.min.css}">
        <style>
            /* Custom Dropzone Styling */
            .dropzone {
                border: 2px dashed #d1d5db;
                border-radius: 0.75rem;
                background: #f9fafb;
                min-height: 200px;
                padding: 2rem;
                transition: all 0.3s ease;
            }
            
            .dropzone:hover {
                border-color: #9ca3af;
                background: #f3f4f6;
            }
            
            .dz-message {
                text-align: center;
                margin: 2em 0;
                color: #6b7280;
            }
            
            .dz-message i {
                font-size: 3rem;
                color: #9ca3af;
                margin-bottom: 1rem;
                display: block;
            }
            
            .dz-preview {
                border-radius: 0.5rem;
                margin: 0.5rem;
                background: white;
                border: 1px solid #e5e7eb;
            }
            
            .dz-upload {
                background: #3b82f6;
                height: 4px;
            }
            
            /* Custom radio and checkbox */
            .form-check-input:checked {
                background-color: #4361ee;
                border-color: #4361ee;
            }
            
            .form-check-input:focus {
                box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
                border-color: #4361ee;
            }
            
            /* Custom file type cards */
            .file-type-card {
                border: 2px solid #e5e7eb;
                border-radius: 0.75rem;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
                background: white;
            }
            
            .file-type-card:hover {
                border-color: #4361ee;
                transform: translateY(-2px);
            }
            
            .file-type-card i {
                font-size: 2.5rem;
                color: #4361ee;
                margin-bottom: 1rem;
            }
            
            .file-type-card.active {
                border-color: #4361ee;
                background-color: #f0f4ff;
            }
            
            /* Progress bar */
            .progress {
                height: 0.75rem;
                border-radius: 1rem;
                background-color: #e5e7eb;
                overflow: visible;
            }
            
            .progress-bar {
                border-radius: 1rem;
                position: relative;
                overflow: visible;
                font-size: 0.75rem;
                font-weight: 600;
                color: #1e40af;
            }
            
            /* File info cards */
            .file-info-card {
                background: #f8fafc;
                border-left: 3px solid #4361ee;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            /* Responsive adjustments */
            @media (max-width: 768px) {
                .upload-options {
                    flex-direction: column;
                    gap: 1rem;
                }
            }
        </style>
    </th:block>
</head>
<body>
    <div>
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="page-title">
                        <i class="fas fa-file-upload text-primary me-2"></i>Data Upload
                    </h1>
                    <p class="page-subtitle">Securely upload and process patient and medical record data</p>
                </div>
                <a href="/ingestion/history" class="btn btn-outline-primary">
                    <i class="fas fa-history me-2"></i>View History
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Upload Card -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Upload Files</h5>
                    </div>
                    <div class="card-body">
                        <!-- File Type Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Select Data Type</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="file-type-card active" data-type="patients">
                                        <i class="fas fa-user-injured"></i>
                                        <h6 class="mb-1">Patient Data</h6>
                                        <p class="text-muted small mb-0">Upload patient demographic information</p>
                                        <input type="radio" class="d-none" name="dataType" id="patientsRadio" value="patients" checked>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="file-type-card" data-type="records">
                                        <i class="fas fa-file-medical"></i>
                                        <h6 class="mb-1">Medical Records</h6>
                                        <p class="text-muted small mb-0">Upload medical history and records</p>
                                        <input type="radio" class="d-none" name="dataType" id="recordsRadio" value="records">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dropzone Area -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Upload Files</label>
                            <form id="uploadForm" th:action="@{/api/ingestion/patients/upload}" method="post" enctype="multipart/form-data" class="dropzone">
                                <div class="dz-message" data-dz-message>
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <h5 class="mt-3 mb-1">Drag & drop files here</h5>
                                    <p class="text-muted mb-2">or click to browse files</p>
                                    <div class="text-muted small">
                                        Supported formats: .csv, .json (Max 10MB)
                                    </div>
                                </div>
                                <input type="hidden" name="_csrf" th:value="${_csrf.token}">
                            </form>
                        </div>
                        
                        <!-- Upload Options -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Upload Options</label>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" role="switch" id="validateOnly">
                                <label class="form-check-label" for="validateOnly">
                                    Validate only (don't save to database)
                                </label>
                                <i class="fas fa-info-circle text-muted ms-2" 
                                   data-bs-toggle="tooltip" 
                                   data-bs-placement="top" 
                                   title="Check this to validate the file structure without saving to the database">
                                </i>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" id="cancelUpload" class="btn btn-outline-secondary" disabled>
                                <i class="fas fa-times me-1"></i> Cancel
                            </button>
                            <button type="button" id="startUpload" class="btn btn-primary" disabled>
                                <i class="fas fa-upload me-1"></i> Start Upload
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="card mt-4 d-none">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-spinner fa-spin text-primary me-2"></i>
                            Upload in Progress
                        </h5>
                        <span class="badge bg-primary">0%</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-1">
                                <span id="fileName" class="fw-medium">filename.csv</span>
                                <span id="fileSize" class="text-muted small">0 MB</span>
                            </div>
                            <div class="progress">
                                <div id="progressBar" class="progress-bar" 
                                     role="progressbar" style="width: 0%" 
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div id="uploadStatus" class="small text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <span>Preparing upload...</span>
                        </div>
                        <div id="uploadDetails" class="mt-3"></div>
                    </div>
                </div>
                
                <!-- Instructions Accordion -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <button class="btn btn-link text-decoration-none text-dark fw-semibold w-100 text-start d-flex justify-content-between align-items-center" 
                                    type="button" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#instructionsCollapse" 
                                    aria-expanded="false" 
                                    aria-controls="instructionsCollapse">
                                <span><i class="fas fa-question-circle text-primary me-2"></i>Upload Instructions</span>
                                <i class="fas fa-chevron-down transition-transform"></i>
                            </button>
                        </h5>
                    </div>
                    <div id="instructionsCollapse" class="collapse">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="mb-3">CSV Format Example:</h6>
                                    <div class="bg-light p-3 rounded-2 mb-4">
                                        <pre class="mb-0"><code>id,firstName,lastName,dateOfBirth,gender,email,phone,address
1,John,Doe,1980-05-15,MALE,john.doe@example.com,1234567890,123 Main St
2,Jane,Smith,1975-10-22,FEMALE,jane.smith@example.com,0987654321,456 Oak Ave</code></pre>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6 class="mb-3">JSON Format Example:</h6>
                                    <div class="bg-light p-3 rounded-2">
                                        <pre class="mb-0"><code>[
  {
    "id": 1,
    "firstName": "John",
    "lastName": "Doe",
    "dateOfBirth": "1980-05-15",
    "gender": "MALE",
    "email": "john.doe@example.com",
    "phone": "1234567890",
    "address": "123 Main St"
  }
]</code></pre>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-4 mb-0">
                                <div class="d-flex">
                                    <i class="fas fa-info-circle mt-1 me-2"></i>
                                    <div>
                                        <h6 class="alert-heading">Important Notes:</h6>
                                        <ul class="mb-0">
                                            <li>Ensure all required fields are included in your file</li>
                                            <li>Date format should be YYYY-MM-DD</li>
                                            <li>File size should not exceed 10MB</li>
                                            <li>For large files, consider compressing to .zip format</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script th:src="@{/js/dropzone.min.js}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize tooltips
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl, {
                        trigger: 'hover'
                    });
                });
                
                // File type selection
                const fileTypeCards = document.querySelectorAll('.file-type-card');
                fileTypeCards.forEach(card => {
                    card.addEventListener('click', function() {
                        // Remove active class from all cards
                        fileTypeCards.forEach(c => c.classList.remove('active'));
                        // Add active class to clicked card
                        this.classList.add('active');
                        // Update the radio input
                        const radio = this.querySelector('input[type="radio"]');
                        if (radio) radio.checked = true;
                        
                        // Update the form action based on selection
                        const form = document.getElementById('uploadForm');
                        const dataType = this.dataset.type;
                        form.action = `/api/ingestion/${dataType}/upload`;
                    });
                });
                
                // Initialize Dropzone
                Dropzone.autoDiscover = false;
                const myDropzone = new Dropzone("#uploadForm", {
                    url: "/api/ingestion/patients/upload",
                    paramName: "file",
                    maxFilesize: 10, // MB
                    maxFiles: 1,
                    acceptedFiles: ".csv,.json",
                    addRemoveLinks: true,
                    autoProcessQueue: false,
                    uploadMultiple: false,
                    createImageThumbnails: false,
                    clickable: true,
                    dictDefaultMessage: "",
                    previewsContainer: false,
                    
                    init: function() {
                        this.on("addedfile", function(file) {
                            // Enable upload button when file is added
                            document.getElementById('startUpload').disabled = false;
                            document.getElementById('cancelUpload').disabled = false;
                            
                            // Update file info in progress card
                            document.getElementById('fileName').textContent = file.name;
                            document.getElementById('fileSize').textContent = (file.size / (1024 * 1024)).toFixed(2) + ' MB';
                            
                            // Show progress card
                            const progressCard = document.getElementById('uploadProgress');
                            progressCard.classList.remove('d-none');
                            
                            // Scroll to progress card
                            setTimeout(() => {
                                progressCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }, 100);
                        });
                        
                        this.on("removedfile", function(file) {
                            // Disable upload button when file is removed
                            document.getElementById('startUpload').disabled = true;
                            document.getElementById('cancelUpload').disabled = true;
                            
                            // Hide progress card if no files
                            if (this.files.length === 0) {
                                document.getElementById('uploadProgress').classList.add('d-none');
                            }
                        });
                        
                        this.on("sending", function(file, xhr, formData) {
                            // Add CSRF token
                            const token = document.querySelector('input[name="_csrf"]').value;
                            xhr.setRequestHeader('X-CSRF-TOKEN', token);
                            
                            // Add validateOnly flag if checked
                            const validateOnly = document.getElementById('validateOnly').checked;
                            formData.append('validateOnly', validateOnly);
                            
                            // Update status
                            const statusElement = document.getElementById('uploadStatus');
                            statusElement.innerHTML = `
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span>Uploading file...</span>
                            `;
                            
                            // Clear previous details
                            document.getElementById('uploadDetails').innerHTML = '';
                        });
                        
                        this.on("uploadprogress", function(file, progress) {
                            // Update progress bar
                            const progressBar = document.getElementById('progressBar');
                            const percent = Math.round(progress);
                            progressBar.style.width = percent + '%';
                            progressBar.setAttribute('aria-valuenow', percent);
                            
                            // Update badge in header
                            document.querySelector('#uploadProgress .badge').textContent = percent + '%';
                        });
                        
                        this.on("success", function(file, response) {
                            // Handle successful upload
                            const statusElement = document.getElementById('uploadStatus');
                            statusElement.innerHTML = `
                                <i class="fas fa-check-circle text-success me-2"></i>
                                <span>${response.message || 'File uploaded successfully!'}</span>
                            `;
                            
                            // Disable upload button after successful upload
                            document.getElementById('startUpload').disabled = true;
                            
                            // Show success message in details
                            const details = document.getElementById('uploadDetails');
                            details.innerHTML = `
                                <div class="alert bg-light border border-success border-opacity-25 text-success mb-0">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Success!</strong> ${response.recordsProcessed || 0} records were processed successfully.
                                </div>
                            `;
                            
                            // Redirect to history after delay if needed
                            if (response.redirect) {
                                setTimeout(() => {
                                    window.location.href = response.redirect;
                                }, 2000);
                            }
                        });
                        
                        this.on("error", function(file, errorMessage) {
                            // Handle upload error
                            const statusElement = document.getElementById('uploadStatus');
                            statusElement.innerHTML = `
                                <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                <span>${errorMessage.message || 'Error uploading file'}</span>
                            `;
                            
                            // Show error details
                            const details = document.getElementById('uploadDetails');
                            details.innerHTML = `
                                <div class="alert bg-light border border-danger border-opacity-25 text-danger">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Error:</strong> ${errorMessage.details || 'An error occurred during upload. Please try again.'}
                                </div>
                            `;
                        });
                    }
                });
                
                // Handle start upload button
                document.getElementById('startUpload').addEventListener('click', function() {
                    if (myDropzone.files.length === 0) {
                        const toast = new bootstrap.Toast(document.getElementById('errorToast'));
                        document.getElementById('toastMessage').textContent = 'Please select a file to upload';
                        toast.show();
                        return;
                    }
                    
                    // Reset progress bar
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = '0%';
                    progressBar.setAttribute('aria-valuenow', '0');
                    
                    // Process the queue
                    myDropzone.processQueue();
                });
                
                // Handle cancel upload button
                document.getElementById('cancelUpload').addEventListener('click', function() {
                    // Remove all files
                    myDropzone.removeAllFiles(true);
                    
                    // Hide progress card
                    document.getElementById('uploadProgress').classList.add('d-none');
                });
            });
            
            // Add smooth scrolling to anchor links
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
        </script>
        
        <!-- Toast for error messages -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
            <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header bg-danger text-white">
                    <strong class="me-auto">Error</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage">
                    An error occurred
                </div>
            </div>
        </div>
    </th:block>
</body>
</html>
                        
                        <h6 class="mt-4">JSON Format (Example):</h6>
                        <pre class="bg-light p-3 rounded">[
  {
    "id": 1,
    "firstName": "John",
    "lastName": "Doe",
    "dateOfBirth": "1980-05-15",
    "gender": "MALE",
    "email": "john.doe@example.com",
    "phone": "1234567890",
    "address": "123 Main St"
  }
]</pre>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>Note:</strong> The first row should contain headers. All fields are required.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script th:src="@{/js/dropzone.min.js}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize Dropzone
                Dropzone.autoDiscover = false;
                
                const myDropzone = new Dropzone("#fileDropzone", {
                    url: "/api/ingestion/patients/upload",
                    paramName: "file",
                    maxFilesize: 10, // MB
                    acceptedFiles: ".csv,.json",
                    addRemoveLinks: true,
                    autoProcessQueue: false,
                    uploadMultiple: false,
                    headers: {
                        'X-CSRF-TOKEN': $('input[name="_csrf"]').val()
                    },
                    init: function() {
                        this.on("addedfile", function(file) {
                            // Update the form action based on the selected data type
                            const dataType = $('input[name="dataType"]:checked').val();
                            const url = `/api/ingestion/${dataType}/upload`;
                            this.options.url = url;
                            
                            // Show the progress bar
                            $('#uploadProgress').removeClass('d-none');
                        });
                        
                        this.on("sending", function(file, xhr, formData) {
                            // Add additional form data
                            formData.append("validateOnly", $('#validateOnly').is(':checked'));
                            
                            // Update status
                            $('#uploadStatus').html(`<i class="fas fa-spinner fa-spin me-1"></i> Uploading ${file.name}...`);
                        });
                        
                        this.on("uploadprogress", function(file, progress) {
                            // Update progress bar
                            const progressBar = $('#progressBar');
                            const progressPercent = Math.round(progress);
                            progressBar.css('width', progressPercent + '%');
                            progressBar.attr('aria-valuenow', progressPercent);
                            progressBar.text(progressPercent + '%');
                        });
                        
                        this.on("success", function(file, response) {
                            // Handle successful upload
                            $('#uploadStatus').html(`
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    <strong>Upload successful!</strong> ${response.recordsProcessed} records processed.
                                </div>
                            `);
                            
                            // Add details if available
                            if (response.errors && response.errors.length > 0) {
                                let errorHtml = '<div class="alert alert-warning mt-2">';
                                errorHtml += '<h6><i class="fas fa-exclamation-triangle me-2"></i>Some issues found:</h6><ul class="mb-0">';
                                response.errors.forEach(error => {
                                    errorHtml += `<li>${error}</li>`;
                                });
                                errorHtml += '</ul></div>';
                                $('#uploadDetails').html(errorHtml);
                            }
                        });
                        
                        this.on("error", function(file, errorMessage) {
                            // Handle errors
                            $('#uploadStatus').html(`
                                <div class="alert alert-danger">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    <strong>Upload failed:</strong> ${errorMessage}
                                </div>
                            `);
                        });
                    }
                });
                
                // Handle the start upload button
                $('#startUpload').on('click', function() {
                    if (myDropzone.getQueuedFiles().length === 0) {
                        alert('Please select a file to upload.');
                        return;
                    }
                    myDropzone.processQueue();
                });
                
                // Update form action when data type changes
                $('input[name="dataType"]').change(function() {
                    const dataType = $(this).val();
                    const url = `/api/ingestion/${dataType}/upload`;
                    myDropzone.options.url = url;
                });
            });
        </script>
    </th:block>
</body>
</html>
